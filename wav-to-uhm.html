---
layout: null
---
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAV to UHM Converter</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Menlo&display=swap" rel="stylesheet">

    <!-- Custom Head (Sidebar/Theme) -->
    {% include head-custom.html %}

    <style>
        :root {
            --bg-color: #1e1e1e;
            --card-bg: #252525;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-color: #3f8cc6;
            /* Blue for this tool to distinguish from AI Gen */
            --accent-hover: #327ab3;
            --input-bg: #2a2a2a;
            --border-color: #333333;
            --code-bg: #111111;
            --dropzone-bg: #222222;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            padding-left: calc(250px + 2rem);
        }

        @media (max-width: 1024px) {
            body {
                padding-left: 2rem;
            }
        }

        .container {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, #fff, var(--accent-color));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        p.subtitle {
            color: var(--text-muted);
            font-size: 1.1rem;
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .dropzone {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            background-color: var(--dropzone-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-muted);
        }

        .dropzone:hover,
        .dropzone.active {
            border-color: var(--accent-color);
            background-color: rgba(63, 140, 198, 0.05);
            /* Tinted with accent */
            color: var(--text-color);
        }

        .dropzone-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        select,
        input[type="text"] {
            width: 100%;
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
            padding: 0.8rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        button.primary-btn {
            background-color: var(--accent-color);
            color: #fff;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
            width: 100%;
        }

        button.primary-btn:hover:not(:disabled) {
            background-color: var(--accent-hover);
        }

        button.primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-area {
            display: none;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }

        .file-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--input-bg);
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .file-name {
            font-family: 'Menlo', monospace;
            font-size: 0.9rem;
        }

        .download-btn {
            background: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: none;
        }

        .download-btn:hover {
            background: var(--accent-color);
            color: white;
        }

        #preview-code {
            font-family: 'Menlo', monospace;
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: pre-wrap;
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>

    <div class="container">
        <div>
            <h1>WAV to UHM Converter</h1>
            <p class="subtitle">Convert audio files into Hive 2 compatible wavetables (.uhm + .wav). Simply drag & drop,
                process, and download.</p>
        </div>

        <div class="card">

            <!-- File Drop Zone -->
            <div id="dropzone" class="dropzone">
                <div class="dropzone-icon">ðŸ“‚</div>
                <div id="dropzone-text">Click or Drag & Drop WAV files here</div>
                <input type="file" id="fileInput" accept=".wav,.aif,.aiff,.mp3" style="display: none;" />
            </div>

            <!-- Settings -->
            <div class="settings-grid">
                <div class="input-group">
                    <label for="modeSelect">Conversion Mode</label>
                    <select id="modeSelect">
                        <option value="import" selected>Standard (WAV Import)</option>
                        <option value="resynthesis">Pure Script (Spectral Resynthesis)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="numFrames">Target Frame Count</label>
                    <input type="text" id="numFrames" value="256" readonly style="opacity: 0.6; cursor: not-allowed;"
                        title="Hive standard is 256 frames">
                </div>
                <div class="input-group">
                    <label for="frameSize">Frame Size (Samples)</label>
                    <select id="frameSize">
                        <option value="2048" selected>2048 (Standard)</option>
                        <option value="1024">1024</option>
                        <option value="4096">4096</option>
                    </select>
                </div>
            </div>

            <button id="convertBtn" class="primary-btn" disabled>Convert File</button>

            <!-- Results -->
            <div id="resultArea" class="result-area">
                <h3>Ready for Download</h3>
                <p style="font-size: 0.9rem; color: var(--text-muted);">Download both files and place them in the same
                    folder.</p>
                <div class="file-list" id="fileList">
                    <!-- Javascript populates this -->
                </div>
                <div style="margin-top: 1rem;">
                    <label>UHM Script Preview:</label>
                    <div id="preview-code"></div>
                </div>
            </div>

        </div>
    </div>

    <!-- Scripts -->
    <script>
        // --- WAV ENCODER UTILITY ---
        function encodeWAV(samples, sampleRate = 44100) {
            const buffer = new ArrayBuffer(44 + samples.length * 2);
            const view = new DataView(buffer);

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + samples.length * 2, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, samples.length * 2, true);

            floatTo16BitPCM(view, 44, samples);

            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function floatTo16BitPCM(output, offset, input) {
            for (let i = 0; i < input.length; i++, offset += 2) {
                let s = Math.max(-1, Math.min(1, input[i]));
                output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
            }
        }

        // --- FFT UTILITY (Simple DFT for exact extraction) ---
        function computeSpectrum(timeData, numHarmonics) {
            const N = timeData.length;
            const harmonics = [];

            // We only care about the first 'numHarmonics' partials (DC = 0 ignored usually, but we can check)
            // k=1 is fundamental
            for (let k = 1; k <= numHarmonics; k++) {
                let real = 0;
                let imag = 0;

                for (let n = 0; n < N; n++) {
                    const angle = (2 * Math.PI * k * n) / N;
                    real += timeData[n] * Math.cos(angle);
                    imag -= timeData[n] * Math.sin(angle);
                }

                // Normalization
                real = real / (N / 2);
                imag = imag / (N / 2);

                const magnitude = Math.sqrt(real * real + imag * imag);
                const phase = Math.atan2(imag, real); // Phase in radians

                harmonics.push({ k, mag: magnitude, phase });
            }
            return harmonics;
        }


        // --- LOGIC ---
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('fileInput');
        const dropzoneText = document.getElementById('dropzone-text');
        const convertBtn = document.getElementById('convertBtn');
        const numFramesInput = document.getElementById('numFrames');
        const frameSizeInput = document.getElementById('frameSize');
        const modeSelect = document.getElementById('modeSelect'); // New
        const resultArea = document.getElementById('resultArea');
        const fileList = document.getElementById('fileList');
        const previewCode = document.getElementById('preview-code');

        let audioContext = new (window.AudioContext || window.webkitAudioContext)();
        let currentBuffer = null;
        let originalFilename = "";

        // Drag & Drop Handlers
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('active');
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('active');
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('active');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            dropzoneText.innerText = `Loading: ${file.name}...`;
            originalFilename = file.name.replace(/\.[^/.]+$/, "");

            const reader = new FileReader();
            reader.onload = function (ev) {
                audioContext.decodeAudioData(ev.target.result, function (buffer) {
                    currentBuffer = buffer;
                    dropzoneText.innerText = `Ready to convert: ${file.name}\nDuration: ${buffer.duration.toFixed(2)}s | Samples: ${buffer.length}`;
                    convertBtn.disabled = false;
                }, function (e) {
                    dropzoneText.innerText = "Error decoding audio file.";
                    console.error(e);
                });
            }
            reader.readAsArrayBuffer(file);
        }

        function resampleAudio(audioBuffer, targetLength) {
            const inputData = audioBuffer.getChannelData(0);
            const inputLength = inputData.length;
            const outputData = new Float32Array(targetLength);
            const ratio = (inputLength - 1) / targetLength;

            for (let i = 0; i < targetLength; i++) {
                const position = i * ratio;
                const index = Math.floor(position);
                const fraction = position - index;
                if (index >= inputLength - 1) {
                    outputData[i] = inputData[inputLength - 1];
                } else {
                    const a = inputData[index];
                    const b = inputData[index + 1];
                    outputData[i] = a + (b - a) * fraction;
                }
            }
            return outputData;
        }

        // Conversion Logic
        convertBtn.addEventListener('click', () => {
            if (!currentBuffer) return;

            const mode = modeSelect.value;
            const targetFrames = parseInt(numFramesInput.value);
            const frameSize = parseInt(frameSizeInput.value);
            const totalSamples = targetFrames * frameSize;
            const resampledData = resampleAudio(currentBuffer, totalSamples);

            // 2. Create UHM Content
            // Info string must be lowercase ascii, max 3 words (per constants.ts rules)
            const infoName = originalFilename.replace(/[^a-zA-Z0-9 ]/g, " ").replace(/\s+/g, " ").trim().toLowerCase();

            // Filenames for files
            const cleanName = originalFilename.replace(/[^a-zA-Z0-9_-]/g, "_");
            const wavName = `${cleanName}_WT.wav`;
            const uhmName = `${cleanName}.uhm`;
            let uhmContent = "";

            if (mode === "import") {
                // --- MODE 1: STANDARD IMPORT ---
                const wavBlob = encodeWAV(resampledData, 44100);

                uhmContent = `Info "${infoName}"
NumFrames = ${targetFrames}
Import "${wavName}"
Spectrum lowest=0 highest=0 "0"
Normalize base=each
`;
                const uhmBlob = new Blob([uhmContent], { type: 'text/plain' });
                showResults(wavBlob, wavName, uhmBlob, uhmName, uhmContent);

            } else {
                // --- MODE 2: SPECTRAL RESYNTHESIS ---
                // Recreating structure using idiomatic Spectrum/Phase commands

                uhmContent = `Info "${infoName}"
NumFrames = ${targetFrames}

// Generated by Spectral Resynthesis
// Using explicit Spectrum and Phase commands for frequency domain definition

`;

                // Config
                const numKeyframes = 9; // Increased to ensure coverage
                const harmonicsToAnalyze = 16;

                // We want keyframes at specific intervals, ensuring last frame is hit.
                // e.g. for 256 frames: 0, 32, 64 ... 224, 255.
                const keyframeIndices = [];
                for (let i = 0; i < numKeyframes - 1; i++) {
                    keyframeIndices.push(Math.floor(i * (targetFrames - 1) / (numKeyframes - 1)));
                }
                keyframeIndices.push(targetFrames - 1); // Ensure exact end
                // Dedup just in case
                const uniqueIndices = [...new Set(keyframeIndices)].sort((a, b) => a - b);

                for (let i = 0; i < uniqueIndices.length; i++) {
                    const frameIndex = uniqueIndices[i];

                    // Extract frame data
                    const startSample = frameIndex * frameSize;
                    const endSample = startSample + frameSize;

                    // Safety check for array bounds
                    if (startSample >= resampledData.length) break;

                    const frameData = resampledData.slice(startSample, endSample);
                    // Pad if necessary (though shouldn't be with correct math)
                    if (frameData.length < frameSize) continue;

                    // FFT
                    const spectrum = computeSpectrum(frameData, harmonicsToAnalyze);

                    // 1. Reset Frame to Silence
                    uhmContent += `Wave start=${frameIndex} end=${frameIndex} "0"\n`;

                    // 2. Set Harmonics
                    spectrum.forEach(h => {
                        if (h.mag > 0.001) {
                            const k = h.k;
                            const mag = h.mag.toFixed(4);

                            // Normalize Phase: atan2 returns -PI to PI. UHM Phase usually 0..1
                            let normPhase = (h.phase + Math.PI) / (2 * Math.PI);
                            normPhase = normPhase % 1;
                            if (normPhase < 0) normPhase += 1;
                            const phaseVal = normPhase.toFixed(4);

                            // Set Magnitude & Phase
                            // Only set for this specific frame
                            uhmContent += `Spectrum start=${frameIndex} end=${frameIndex} lowest=${k} highest=${k} "${mag}"\n`;
                            uhmContent += `Phase start=${frameIndex} end=${frameIndex} lowest=${k} highest=${k} "${phaseVal}"\n`;
                        }
                    });

                    uhmContent += `\n`;
                }

                // Interpolate gaps
                for (let i = 0; i < uniqueIndices.length - 1; i++) {
                    let start = uniqueIndices[i];
                    let end = uniqueIndices[i + 1];

                    if (end - start > 1) {
                        // Interpolate "morph" is usually better for spectral, or "crossfade"
                        uhmContent += `Interpolate start=${start} end=${end}\n`;
                    }
                }

                uhmContent += `
Spectrum lowest=0 highest=0 "0" // DC Remove
Normalize base=each
`;

                const uhmBlob = new Blob([uhmContent], { type: 'text/plain' });
                const wavBlob = encodeWAV(resampledData, 44100);

                showResults(wavBlob, wavName, uhmBlob, uhmName, uhmContent);
            }
        });

        function showResults(wavBlob, wavName, uhmBlob, uhmName, uhmCode) {
            resultArea.style.display = 'flex';
            fileList.innerHTML = '';
            previewCode.innerText = uhmCode;

            const uhmUrl = URL.createObjectURL(uhmBlob);
            addDownloadItem(uhmName, uhmUrl, "primary-btn");

            // WAV is secondary in pure mode, primary in import mode
            const wavUrl = URL.createObjectURL(wavBlob);
            addDownloadItem(wavName, wavUrl, "secondary-btn");
        }

        function addDownloadItem(filename, url, btnClass) {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `
                <span class="file-name">${filename}</span>
                <a href="${url}" download="${filename}" class="download-btn" style="${btnClass === 'secondary-btn' ? 'color: #999; border-color: #555;' : ''}">Download</a>
            `;
            fileList.appendChild(div);
        }

    </script>
</body>

</html>